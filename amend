#!/bin/bash
set -e #exit on failed command
set -u #fail on undefined variable
#set -x #print commands

. ~/log-utils.sh

dry_run=false
force=false

for arg in "$@"; do
  case "$arg" in
    -n)
      dry_run=true
      ;;
    -f)
      force=true
      ;;
    *)
      echo "Unknown flag: $arg"
      echo "Usage: amend [-n] [-f]"
      exit 1
      ;;
  esac
done

if git diff --staged --quiet; then
  echo "No staged changes. Exiting."
  exit 0
fi

echo "$(tput bold)$(tput setaf 6)Adding these files to the current commit$(tput sgr0)"
echo
git --no-pager diff --staged
echo
echo "$(tput bold)$(tput setaf 6)Current commit message$(tput sgr0)"
echo
git log -1 --format=%B


if [[ "$dry_run" == true ]]; then
  # Dry run
  exit
fi

if [[ "$force" != true ]]; then
  echo
  read -r -p "Continue? [Y/n] " continue_response
  case "$continue_response" in
    ""|[Yy])
      ;;
    *)
      echo "Cancelled."
      exit 0
      ;;
  esac
fi

git commit --amend --no-edit
git push --force-with-lease
ok "Pushed amended commit to remote."
