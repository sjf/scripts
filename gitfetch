#!/bin/bash
set -u #fail on undefined variable
set -x #print commands

. ~/scripts/git-utils

UPDATED=no

# just drop changes to this file because it is useless and always getting auto-updated
[[ -f package-lock.json ]] && git restore package-lock.json
[[ -f tools/go.work.sum ]] && git restore tools/go.work.sum
[[ -f apps/frontend/dashboard/pnpm-lock.yaml ]] && git restore apps/frontend/dashboard/pnpm-lock.yaml

set -e #exit on failed command

stash_before gitfetch-tmp


echo "git fetch && git fetch origin && git rebase origin/$MAIN"
if set +u git fetch && git fetch origin && git rebase origin/$MAIN; then

  # was HEAD updated?
  if [[ "$(git rev-parse HEAD)" != "$(git rev-parse HEAD@{1})" ]]; then
    UPDATED=yes
  fi
else
  rich "[bold red]Failed to fetch and rebase[/bold red]" --print
fi

# Reset -u
set -u

pop_after || (rich "[bold red]FAILED TO POP STASH![/bold red]" --print && exit 1)


if [[ $UPDATED != yes ]]; then
  rich "[yellow]No changes fetched" --print
  exit 0
fi

git log --oneline HEAD@{1}..HEAD

[[ -f package.json ]] && grep install:all package.json && npm run install:all

if [[ $CURRENT_BRANCH != "$MAIN" ]]; then
  # Update remote branch
  git push --force-with-lease

  gh pr view --json url --jq '.url' 2>/dev/null || createPrUrl
fi
